<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- First load auth-utils.js to immediately apply authentication state -->
  <script src="../js/auth-utils.js"></script>
  <!-- favicon -->
  <link rel="icon" type="image/png" href="../images/favicon/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="../images/favicon/favicon.svg" />
  <link rel="shortcut icon" href="../images/favicon/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="../images/favicon/apple-touch-icon.png" />
  <link rel="manifest" href="../images/favicon/site.webmanifest" />
  <!-- Google fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet" />
  <!-- font awesome -->
  <script src="https://kit.fontawesome.com/3dcfe32b12.js" crossorigin="anonymous"></script>
  <!-- style -->
  <link rel="stylesheet" href="../css/style.css" />
  <link rel="stylesheet" href="../css/responsive.css" />
  <title>Login/Register | TalashNow</title>
</head>
<body>
  <header>
    <nav id="navbar" class="uni-padding">
      <div class="nav-content">
        <a href="../index.html" class="logo-link">
          <img src="../images/TN2b.png" alt="TalashNow Logo" class="logo" />
        </a>
        <button class="hamburger" aria-label="Toggle menu">
          <span class="bar"></span>
          <span class="bar"></span>
          <span class="bar"></span>
        </button>
        <ul class="nav-menu">
          <li><a href="../index.html">Home</a></li>
          <li><a href="lost.html">Lost Item</a></li>
          <li><a href="found.html">Found Item</a></li>
          <li><a href="about.html">About us</a></li>
          <li><a href="contact.html">Contact us</a></li>
        </ul>
        <div class="nav-buttons nav-menu">
          <div id="auth-buttons">
            <a href="/pages/auth.html?form=login" id="login-btn"><button class="nav-btn" data-form="login">Login</button></a>
            <a href="/pages/auth.html?form=register" id="register-btn"><button class="nav-btn" data-form="register">Register</button></a>
          </div>
          <div id="user-buttons" style="display: none;">
            <a href="/pages/dashboard.html"><button class="nav-btn">Dashboard</button></a>
            <button class="nav-btn" id="logout-btn">Logout</button>
          </div>
        </div>
      </div>
    </nav>
  </header>

  <!-- Notification Popup -->
  <div id="notification"></div>

  <!-- Authentication Container -->
  <div class="auth-container wrapper">
    <div class="auth-form" id="login-form">
      <div class="form-title">
        <i class="fas fa-sign-in-alt"></i> Login
      </div>
      <form id="loginForm" action="#" method="POST">
        <div class="form-group">
          <label for="login-email">Email *</label>
          <input type="email" id="login-email" name="login-email" placeholder="Enter your email" required autocomplete="on">
        </div>
        <div class="form-group">
          <label for="login-password">Password *</label>
          <input type="password" id="login-password" name="login-password" placeholder="Enter your password" required autocomplete="on">
        </div>
        <div class="form-group">
          <a href="#" class="forgot-password">Forgot password?</a>
        </div>
        <button type="submit" class="submit-btn">Login</button>
      </form>
      <p class="toggle-link">Don't have an account? <a href="?form=register" data-form="register">Register</a></p>
    </div>

    <div class="auth-form" id="register-form">
      <div class="form-title">
        <i class="fas fa-user-plus"></i> Register
      </div>
      <form id="registerForm" action="#" method="POST">
        <div class="form-group">
          <label for="register-name">Full Name *</label>
          <input type="text" id="register-name" name="register-name" placeholder="Enter your full name" required autocomplete="on">
        </div>
        <div class="form-group">
          <label for="register-email">Email *</label>
          <input type="email" id="register-email" name="register-email" placeholder="Enter your email" required autocomplete="on">
        </div>
        <div class="form-group">
          <label for="register-password">Password *</label>
          <input type="password" id="register-password" name="register-password" placeholder="Create a password" required autocomplete="on">
        </div>
        <button type="submit" class="submit-btn">Register</button>
      </form>
      <p class="toggle-link">Already have an account? <a href="?form=login" data-form="login">Login</a></p>
    </div>
  </div>

  <footer class="site-footer">
    <div class="footer-container">
      <div class="footer-grid">
        <div class="footer-column">
          <h3 class="footer-heading">Services</h3>
          <ul class="footer-links">
            <li><a href="lost.html">Lost Item Report</a></li>
            <li><a href="found.html">Found Item Report</a></li>
            <li><a href="lost.html">AutoMatch Alerts</a></li>
          </ul>
        </div>
        <div class="footer-column">
          <h3 class="footer-heading">Quick Links</h3>
          <ul class="footer-links">
            <li><a href="../index.html">Home</a></li>
            <li><a href="lost.html">Lost Items</a></li>
            <li><a href="found.html">Found Items</a></li>
            <li><a href="lost.html">Recent Posts</a></li>
          </ul>
        </div>
        <div class="footer-column">
          <h3 class="footer-heading">Contact</h3>
          <ul class="footer-contact">
            <li><i class="fas fa-map-marker-alt"></i> AT245 Phase 2 Bin Qasim Town</li>
            <li><i class="fas fa-phone"></i> +92 300 1234567</li>
            <li><i class="fas fa-envelope"></i> help@talashnow.com</li>
          </ul>
        </div>
      </div>
      <div class="footer-bottom">
        <div class="footer-content">
          <p>&copy; 2025 TalashNow</p>
          <div class="social-icons">
            <a href="#"><i class="fab fa-facebook-f"></i></a>
            <a href="#"><i class="fab fa-twitter"></i></a>
            <a href="#"><i class="fab fa-instagram"></i></a>
          </div>
        </div>
      </div>
    </div>
  </footer>

  <script src="../js/api.js"></script>
  <script src="../js/scripts.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const forms = document.querySelectorAll('.auth-form');
      const toggleLinks = document.querySelectorAll('.toggle-link a');
      const navButtons = document.querySelectorAll('.nav-btn');
      const notification = document.getElementById('notification');

      // Check if user is already authenticated
      const isAuthenticated = localStorage.getItem('isAuthenticated') === 'true';
      if (isAuthenticated) {
        window.location.href = 'dashboard.html';
        return;
      }

      function showNotification(message, type = 'success') {
        notification.textContent = message;
        notification.className = type;
        notification.classList.add('show');
        setTimeout(() => {
          notification.classList.remove('show');
          notification.textContent = '';
          notification.className = '';
        }, 4000);
      }

      function showFormFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        const formType = urlParams.get('form') || 'login';
        forms.forEach(form => {
          form.style.display = form.id === `${formType}-form` ? 'block' : 'none';
        });
      }
      showFormFromURL();

      toggleLinks.forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const targetForm = link.getAttribute('data-form');
          forms.forEach(form => {
            form.style.display = form.id === `${targetForm}-form` ? 'block' : 'none';
          });
          window.history.replaceState(null, null, `?form=${targetForm}`);
        });
      });

      navButtons.forEach(button => {
        if (!button.getAttribute('data-form')) return;
        
        button.addEventListener('click', (e) => {
          const targetForm = button.getAttribute('data-form');
          if (!targetForm) return;
          
          forms.forEach(form => {
            form.style.display = form.id === `${targetForm}-form` ? 'block' : 'none';
          });
          window.history.replaceState(null, null, `?form=${targetForm}`);
        });
      });

      // Login form submission
      document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;

        try {
          const response = await authAPI.login(email, password);
          console.log('Login response:', response);
          
          if (response.success) {
            // IMMEDIATELY set authentication state in localStorage
            localStorage.setItem('isAuthenticated', 'true');
            
            // Store user data from response
            if (response.data && (response.data.user || response.data)) {
              const userData = response.data.user || response.data;
              console.log('Storing user data:', userData);
              
              // Check if we need to transform the data before storing
              if (userData._id && typeof userData._id === 'string') {
                // If the _id is a string but looks like a MongoDB ObjectId, convert it to the proper format
                if (userData._id.match(/^[0-9a-f]{24}$/)) {
                  console.log('Converting string ID to MongoDB ObjectId format:', userData._id);
                  userData._id = { $oid: userData._id };
                }
              }
              
              try {
                localStorage.setItem('userData', JSON.stringify(userData));
                console.log('User data stored in localStorage');
                
                // Also store any token if provided
                if (response.data.token) {
                  localStorage.setItem('token', response.data.token);
                  console.log('Stored authentication token');
                }
              } catch (storageError) {
                console.error('Error storing user data:', storageError);
              }
            } else {
              console.warn('No user data in login response to store');
            }
            
            // Set global state variable
            window.TalashNow = window.TalashNow || {};
            window.TalashNow.isAuthenticated = true;
            
            // Try to set user data in global state
            try {
              const userDataStr = localStorage.getItem('userData');
              if (userDataStr) {
                window.TalashNow.userData = JSON.parse(userDataStr);
              }
            } catch (e) {
              console.error('Error parsing user data for global state:', e);
            }
            
            // IMMEDIATELY update UI 
            const authButtons = document.getElementById('auth-buttons');
            const userButtons = document.getElementById('user-buttons');
            
            if (authButtons && userButtons) {
              authButtons.style.display = 'none';
              userButtons.style.display = 'block';
            }
            
            // Add !important style to ensure it takes precedence
            const style = document.createElement('style');
            style.textContent = `
              #auth-buttons { display: none !important; }
              #user-buttons { display: block !important; }
            `;
            document.head.appendChild(style);
            
            // Show success notification
            showNotification('Login successful!', 'success');
            
            // Redirect after a delay, using the location.replace to avoid history issues
            setTimeout(() => {
              window.location.replace('/pages/dashboard.html');
            }, 1500);
          } else {
            showNotification(`Login failed: ${response.message || 'Invalid credentials'}`, 'error');
          }
        } catch (error) {
          console.error('Login error:', error);
          showNotification(`Login failed: ${error.message || 'An error occurred'}`, 'error');
        }
      });

      // Register form submission
      document.getElementById('registerForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('register-name').value;
        const email = document.getElementById('register-email').value;
        const password = document.getElementById('register-password').value;

        try {
          const response = await authAPI.register(name, email, password);
          if (response.success) {
            // Store user data from response if available
            if (response.data && (response.data.user || response.data)) {
              const userData = response.data.user || response.data;
              console.log('Storing user data from registration:', userData);
              
              try {
                localStorage.setItem('userData', JSON.stringify(userData));
                
                // Also store any token if provided
                if (response.data.token) {
                  localStorage.setItem('token', response.data.token);
                  console.log('Stored authentication token from registration');
                }
                
                // Set global state
                window.TalashNow = window.TalashNow || {};
                window.TalashNow.userData = userData;
              } catch (storageError) {
                console.error('Error storing user data from registration:', storageError);
              }
            }
            
            showNotification('Registration successful! Please login.', 'success');
            setTimeout(() => {
              forms.forEach(form => {
                form.style.display = form.id === 'login-form' ? 'block' : 'none';
              });
              window.history.replaceState(null, null, `?form=login`);
            }, 1500);
          } else {
            showNotification(`Registration failed: ${response.message || 'Please try again'}`, 'error');
          }
        } catch (error) {
          showNotification(`Registration failed: ${error.message || 'An error occurred'}`, 'error');
        }
      });
    });
  </script>
</body>
</html>